import { databaseOpenRaw } from "./databaseOpen.js";
import type { StorageDatabase } from "./databaseOpen.js";

const databaseOpenTestByKey = new Map<string, StorageDatabase>();
const databaseOpenTestGlobal = globalThis as {
    __daycareDatabaseOpenOverride?: (dbPath: string) => StorageDatabase | null;
};

/**
 * Opens a test-only in-memory SQLite database.
 * Expects: optional key is stable when a test needs reopen semantics.
 */
export function databaseOpenTest(key?: string): StorageDatabase {
    if (!key || key === ":memory:") {
        return databaseOpenRaw(":memory:");
    }

    const existing = databaseOpenTestByKey.get(key);
    if (existing) {
        return existing;
    }

    const db = databaseOpenRaw(":memory:");
    databaseOpenTestPathAttach(db, key);
    databaseOpenTestCloseDisable(db);
    databaseOpenTestByKey.set(key, db);
    return db;
}

function databaseOpenTestPathAttach(db: StorageDatabase, path: string | null): void {
    if (!path) {
        return;
    }
    (db as StorageDatabase & { __daycareDatabasePath?: string }).__daycareDatabasePath = path;
}

function databaseOpenTestCloseDisable(db: StorageDatabase): void {
    (db as StorageDatabase & { close: () => StorageDatabase }).close = (): StorageDatabase => db;
}

if (!databaseOpenTestGlobal.__daycareDatabaseOpenOverride) {
    databaseOpenTestGlobal.__daycareDatabaseOpenOverride = (dbPath: string): StorageDatabase => {
        return databaseOpenTest(dbPath);
    };
}
