import { databaseMigrate } from "./databaseMigrate.js";
import { databaseOpenTest } from "./databaseOpenTest.js";
import { Storage } from "./storage.js";

/**
 * Opens in-memory test storage, applies migrations, and returns Storage facade.
 * Expects: always returns a fresh in-memory storage instance.
 */
export async function storageOpenTest(): Promise<Storage> {
    const db = databaseOpenTest();
    await databaseMigrate(db);
    const storage = Storage.fromDatabase(db);
    const owner = await storage.users.findOwner();
    if (!owner) {
        await storage.users.create({
            id: "sy45wijd1hmr03ef2wu7busv",
            isOwner: true,
            createdAt: 0,
            updatedAt: 0,
            nametag: "owner"
        });
    }
    return storage;
}
